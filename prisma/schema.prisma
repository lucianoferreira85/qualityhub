generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String            @id @db.Uuid
  email           String            @unique
  name            String
  role            String            @default("user")
  department      String?
  createdAt       DateTime          @default(now()) @map("created_at")
  audits          Audit[]
  nonconformities Nonconformity[]
  actions         Action[]
  documents       Document[]
  riskAssessments RiskAssessment[]
  indicators      Indicator[]

  @@map("users")
}

model Audit {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title           String
  type            String
  standard        String
  scope           String?
  startDate       DateTime        @map("start_date") @db.Date
  endDate         DateTime?       @map("end_date") @db.Date
  status          String          @default("planned")
  leadAuditorId   String          @map("lead_auditor_id") @db.Uuid
  conclusion      String?
  notes           String?
  userId          String          @map("user_id") @db.Uuid
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  findings        AuditFinding[]
  nonconformities Nonconformity[]

  @@index([userId])
  @@index([status])
  @@map("audits")
}

model AuditFinding {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auditId     String @map("audit_id") @db.Uuid
  clause      String
  type        String
  description String
  evidence    String?
  audit       Audit  @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@map("audit_findings")
}

model Nonconformity {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code            String    @unique
  title           String
  description     String
  evidence        String?
  severity        String
  source          String
  status          String    @default("open")
  rootCause       String?   @map("root_cause")
  rootCauseMethod String?   @map("root_cause_method")
  auditId         String?   @map("audit_id") @db.Uuid
  responsibleId   String    @map("responsible_id") @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  dueDate         DateTime? @map("due_date") @db.Date
  closedAt        DateTime? @map("closed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  audit           Audit?    @relation(fields: [auditId], references: [id])
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  actions         Action[]

  @@index([userId])
  @@index([status])
  @@index([auditId])
  @@map("nonconformities")
}

model Action {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code              String         @unique
  title             String
  description       String
  type              String
  status            String         @default("planned")
  responsibleId     String         @map("responsible_id") @db.Uuid
  nonconformityId   String?        @map("nonconformity_id") @db.Uuid
  dueDate           DateTime       @map("due_date") @db.Date
  completedAt       DateTime?      @map("completed_at")
  verifiedAt        DateTime?      @map("verified_at")
  verificationNotes String?        @map("verification_notes")
  isEffective       Boolean?       @map("is_effective")
  userId            String         @map("user_id") @db.Uuid
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  nonconformity     Nonconformity? @relation(fields: [nonconformityId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([nonconformityId])
  @@map("actions")
}

model Document {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String    @unique
  title      String
  type       String
  category   String?
  version    String    @default("1.0")
  status     String    @default("draft")
  content    String?
  fileUrl    String?   @map("file_url")
  authorId   String    @map("author_id") @db.Uuid
  reviewerId String?   @map("reviewer_id") @db.Uuid
  approverId String?   @map("approver_id") @db.Uuid
  approvedAt DateTime? @map("approved_at")
  userId     String    @map("user_id") @db.Uuid
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("documents")
}

model Indicator {
  id           String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  description  String?
  unit         String
  frequency    String
  target       Decimal                @db.Decimal(12, 2)
  lowerLimit   Decimal?               @map("lower_limit") @db.Decimal(12, 2)
  upperLimit   Decimal?               @map("upper_limit") @db.Decimal(12, 2)
  processId    String?                @map("process_id") @db.Uuid
  userId       String                 @map("user_id") @db.Uuid
  createdAt    DateTime               @default(now()) @map("created_at")
  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  measurements IndicatorMeasurement[]

  @@index([userId])
  @@map("indicators")
}

model IndicatorMeasurement {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  indicatorId String    @map("indicator_id") @db.Uuid
  value       Decimal   @db.Decimal(12, 2)
  period      DateTime  @db.Date
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  indicator   Indicator @relation(fields: [indicatorId], references: [id], onDelete: Cascade)

  @@index([indicatorId, period])
  @@map("indicator_measurements")
}

model RiskAssessment {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  description   String
  type          String
  category      String
  probability   Int
  impact        Int
  riskLevel     String   @map("risk_level")
  treatment     String?
  treatmentPlan String?  @map("treatment_plan")
  responsibleId String   @map("responsible_id") @db.Uuid
  status        String   @default("identified")
  userId        String   @map("user_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([riskLevel])
  @@map("risk_assessments")
}
