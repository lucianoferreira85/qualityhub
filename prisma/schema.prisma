generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum TenantStatus {
  active
  trial
  suspended
  cancelled
}

enum OrgRole {
  tenant_admin
  project_manager
  senior_consultant
  junior_consultant
  internal_auditor
  external_auditor
  client_viewer
}

enum InvitationStatus {
  pending
  accepted
  expired
  revoked
}

enum SubscriptionStatus {
  active
  trialing
  past_due
  cancelled
}

enum ProjectStatus {
  planning
  in_progress
  completed
  archived
}

enum RequirementStatus {
  not_started
  in_progress
  implemented
  verified
  nonconforming
}

enum NcStatus {
  open
  analysis
  action_defined
  in_execution
  effectiveness_check
  closed
}

enum NcSeverity {
  observation
  minor
  major
  critical
}

enum FindingClassification {
  conformity
  observation
  opportunity
  minor_nc
  major_nc
}

enum ActionType {
  corrective
  preventive
  improvement
}

enum ActionStatus {
  planned
  in_progress
  completed
  verified
  effective
  ineffective
}

enum DocumentType {
  policy
  procedure
  work_instruction
  form
  record
  manual
}

enum DocumentStatus {
  draft
  in_review
  approved
  obsolete
}

enum RootCauseMethod {
  five_whys
  ishikawa
  fault_tree
  brainstorming
}

// ==================== GLOBAL MODELS (Super Admin) ====================

model Plan {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  slug          String         @unique
  price         Decimal        @db.Decimal(10, 2)
  maxUsers      Int            @map("max_users")
  maxProjects   Int            @map("max_projects")
  maxStandards  Int            @map("max_standards")
  maxStorage    Int            @map("max_storage") // in MB
  maxClients    Int            @map("max_clients")
  features      Json           @default("{}")
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  subscriptions Subscription[]

  @@map("plans")
}

model Standard {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String            @unique
  name        String
  version     String
  year        Int
  status      String            @default("active")
  description String?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  clauses     StandardClause[]
  controls    StandardControl[]
  projects    ProjectStandard[]

  @@map("standards")
}

model StandardClause {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  standardId          String               @map("standard_id") @db.Uuid
  code                String
  title               String
  description         String?
  parentId            String?              @map("parent_id") @db.Uuid
  orderIndex          Int                  @default(0) @map("order_index")
  createdAt           DateTime             @default(now()) @map("created_at")
  standard            Standard             @relation(fields: [standardId], references: [id], onDelete: Cascade)
  parent              StandardClause?      @relation("ClauseHierarchy", fields: [parentId], references: [id])
  children            StandardClause[]     @relation("ClauseHierarchy")
  projectRequirements ProjectRequirement[]
  nonconformities     Nonconformity[]
  auditFindings       AuditFinding[]

  @@unique([standardId, code])
  @@index([standardId])
  @@index([parentId])
  @@map("standard_clauses")
}

model StandardControl {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  standardId      String           @map("standard_id") @db.Uuid
  code            String
  title           String
  domain          String?
  type            String?
  attributes      Json             @default("{}")
  createdAt       DateTime         @default(now()) @map("created_at")
  standard        Standard         @relation(fields: [standardId], references: [id], onDelete: Cascade)
  projectControls ProjectControl[]
  soaEntries      SoaEntry[]
  riskTreatments  RiskTreatment[]

  @@unique([standardId, code])
  @@index([standardId])
  @@map("standard_controls")
}

// ==================== TENANT MODEL ====================

model Tenant {
  id           String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  slug         String             @unique
  logo         String?
  cnpj         String?
  settings     Json               @default("{}")
  status       TenantStatus       @default(trial)
  trialEndsAt  DateTime?          @map("trial_ends_at")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  members      TenantMember[]
  invitations  Invitation[]
  subscription Subscription?
  clients      ConsultingClient[]
  projects     Project[]
  risks        Risk[]
  actionPlans  ActionPlan[]
  nonconformities Nonconformity[]
  audits       Audit[]
  documents    Document[]
  indicators   Indicator[]
  reviews      ManagementReview[]
  auditLogs    AuditLog[]
  notifications Notification[]
  requirements ProjectRequirement[]
  controls     ProjectControl[]
  soaEntries   SoaEntry[]
  measurements IndicatorMeasurement[]
  auditFindings AuditFinding[]

  @@map("tenants")
}

// ==================== USER & MEMBERSHIP ====================

model User {
  id          String         @id @db.Uuid
  email       String         @unique
  name        String
  avatarUrl   String?        @map("avatar_url")
  isSuperAdmin Boolean       @default(false) @map("is_super_admin")
  isActive    Boolean        @default(true) @map("is_active")
  lastLoginAt DateTime?      @map("last_login_at")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  memberships TenantMember[]
  invitationsSent Invitation[] @relation("InvitedBy")
  projectMembers ProjectMember[]
  assignedRequirements ProjectRequirement[] @relation("RequirementResponsible")
  assignedControls ProjectControl[] @relation("ControlResponsible")
  assignedRisks Risk[] @relation("RiskResponsible")
  assignedActions ActionPlan[] @relation("ActionResponsible")
  assignedNcs Nonconformity[] @relation("NcResponsible")
  leadAudits Audit[] @relation("LeadAuditor")
  authoredDocuments Document[] @relation("DocumentAuthor")
  reviewedDocuments Document[] @relation("DocumentReviewer")
  approvedDocuments Document[] @relation("DocumentApprover")
  documentVersions DocumentVersion[]
  auditLogs AuditLog[]
  notifications Notification[]

  @@map("users")
}

model TenantMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      OrgRole  @default(junior_consultant)
  invitedById String? @map("invited_by_id") @db.Uuid
  joinedAt  DateTime @default(now()) @map("joined_at")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("tenant_members")
}

model Invitation {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String           @map("tenant_id") @db.Uuid
  email     String
  role      OrgRole          @default(junior_consultant)
  token     String           @unique @default(dbgenerated("gen_random_uuid()"))
  status    InvitationStatus @default(pending)
  expiresAt DateTime         @map("expires_at")
  invitedById String         @map("invited_by_id") @db.Uuid
  createdAt DateTime         @default(now()) @map("created_at")
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invitedBy User             @relation("InvitedBy", fields: [invitedById], references: [id])

  @@index([tenantId])
  @@index([token])
  @@index([email])
  @@map("invitations")
}

// ==================== BILLING ====================

model Subscription {
  id                   String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String             @unique @map("tenant_id") @db.Uuid
  planId               String             @map("plan_id") @db.Uuid
  status               SubscriptionStatus @default(trialing)
  stripeCustomerId     String?            @map("stripe_customer_id")
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan                 Plan               @relation(fields: [planId], references: [id])

  @@index([tenantId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

// ==================== CONSULTING CLIENTS ====================

model ConsultingClient {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  name         String
  cnpj         String?
  contactName  String?   @map("contact_name")
  contactEmail String?   @map("contact_email")
  sector       String?
  status       String    @default("active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects     Project[]

  @@index([tenantId])
  @@map("consulting_clients")
}

// ==================== PROJECTS ====================

model Project {
  id            String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String               @map("tenant_id") @db.Uuid
  name          String
  description   String?
  clientId      String?              @map("client_id") @db.Uuid
  status        ProjectStatus        @default(planning)
  startDate     DateTime?            @map("start_date") @db.Date
  endDate       DateTime?            @map("end_date") @db.Date
  progress      Decimal              @default(0) @db.Decimal(5, 2)
  archivedAt    DateTime?            @map("archived_at")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client        ConsultingClient?    @relation(fields: [clientId], references: [id])
  standards     ProjectStandard[]
  members       ProjectMember[]
  requirements  ProjectRequirement[]
  controls      ProjectControl[]
  soaEntries    SoaEntry[]
  risks         Risk[]
  actionPlans   ActionPlan[]
  nonconformities Nonconformity[]
  audits        Audit[]
  documents     Document[]
  indicators    Indicator[]
  reviews       ManagementReview[]

  @@index([tenantId])
  @@index([clientId])
  @@index([status])
  @@map("projects")
}

model ProjectStandard {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId  String   @map("project_id") @db.Uuid
  standardId String   @map("standard_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  standard   Standard @relation(fields: [standardId], references: [id])

  @@unique([projectId, standardId])
  @@map("project_standards")
}

model ProjectMember {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String  @map("project_id") @db.Uuid
  userId    String  @map("user_id") @db.Uuid
  role      String  @default("member")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

// ==================== REQUIREMENTS & CONTROLS ====================

model ProjectRequirement {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String            @map("tenant_id") @db.Uuid
  projectId     String            @map("project_id") @db.Uuid
  clauseId      String            @map("clause_id") @db.Uuid
  status        RequirementStatus @default(not_started)
  maturity      Int               @default(0) @db.SmallInt
  responsibleId String?           @map("responsible_id") @db.Uuid
  dueDate       DateTime?         @map("due_date") @db.Date
  notes         String?
  evidence      String?
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  clause        StandardClause    @relation(fields: [clauseId], references: [id])
  responsible   User?             @relation("RequirementResponsible", fields: [responsibleId], references: [id])

  @@unique([projectId, clauseId])
  @@index([tenantId])
  @@index([projectId])
  @@map("project_requirements")
}

model ProjectControl {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String          @map("tenant_id") @db.Uuid
  projectId           String          @map("project_id") @db.Uuid
  controlId           String          @map("control_id") @db.Uuid
  status              RequirementStatus @default(not_started)
  maturity            Int             @default(0) @db.SmallInt
  responsibleId       String?         @map("responsible_id") @db.Uuid
  implementationNotes String?         @map("implementation_notes")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project             Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  control             StandardControl @relation(fields: [controlId], references: [id])
  responsible         User?           @relation("ControlResponsible", fields: [responsibleId], references: [id])

  @@unique([projectId, controlId])
  @@index([tenantId])
  @@index([projectId])
  @@map("project_controls")
}

model SoaEntry {
  id                   String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String          @map("tenant_id") @db.Uuid
  projectId            String          @map("project_id") @db.Uuid
  controlId            String          @map("control_id") @db.Uuid
  applicable           Boolean         @default(true)
  justification        String?
  implementationStatus String?         @map("implementation_status")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")
  tenant               Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project              Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  control              StandardControl @relation(fields: [controlId], references: [id])

  @@unique([projectId, controlId])
  @@index([tenantId])
  @@index([projectId])
  @@map("soa_entries")
}

// ==================== RISKS ====================

model Risk {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String          @map("tenant_id") @db.Uuid
  projectId           String          @map("project_id") @db.Uuid
  code                String
  title               String
  description         String
  category            String
  impactDimensions    Json            @default("{}") @map("impact_dimensions")
  probability         Int             @db.SmallInt
  impact              Int             @db.SmallInt
  riskLevel           String          @map("risk_level")
  treatment           String?
  treatmentPlan       String?         @map("treatment_plan")
  responsibleId       String?         @map("responsible_id") @db.Uuid
  status              String          @default("identified")
  residualProbability Int?            @map("residual_probability") @db.SmallInt
  residualImpact      Int?            @map("residual_impact") @db.SmallInt
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project             Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible         User?           @relation("RiskResponsible", fields: [responsibleId], references: [id])
  treatments          RiskTreatment[]
  actionPlans         ActionPlan[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@index([riskLevel])
  @@map("risks")
}

model RiskTreatment {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riskId      String          @map("risk_id") @db.Uuid
  controlId   String?         @map("control_id") @db.Uuid
  description String
  status      String          @default("planned")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  risk        Risk            @relation(fields: [riskId], references: [id], onDelete: Cascade)
  control     StandardControl? @relation(fields: [controlId], references: [id])

  @@index([riskId])
  @@map("risk_treatments")
}

// ==================== NONCONFORMITIES ====================

model Nonconformity {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String         @map("tenant_id") @db.Uuid
  projectId     String         @map("project_id") @db.Uuid
  code          String
  title         String
  description   String
  origin        String
  type          String?
  severity      NcSeverity     @default(minor)
  clauseId      String?        @map("clause_id") @db.Uuid
  status        NcStatus       @default(open)
  responsibleId String?        @map("responsible_id") @db.Uuid
  dueDate       DateTime?      @map("due_date") @db.Date
  closedAt      DateTime?      @map("closed_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  clause        StandardClause? @relation(fields: [clauseId], references: [id])
  responsible   User?          @relation("NcResponsible", fields: [responsibleId], references: [id])
  rootCause     NcRootCause?
  actionPlans   ActionPlan[]
  auditFindings AuditFinding[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@index([status])
  @@map("nonconformities")
}

model NcRootCause {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nonconformityId String          @unique @map("nonconformity_id") @db.Uuid
  method          RootCauseMethod
  analysis        Json            @default("{}")
  conclusion      String?
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  nonconformity   Nonconformity   @relation(fields: [nonconformityId], references: [id], onDelete: Cascade)

  @@map("nc_root_causes")
}

// ==================== ACTION PLANS ====================

model ActionPlan {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String       @map("tenant_id") @db.Uuid
  projectId         String       @map("project_id") @db.Uuid
  code              String
  title             String
  description       String
  type              ActionType
  status            ActionStatus @default(planned)
  responsibleId     String?      @map("responsible_id") @db.Uuid
  nonconformityId   String?      @map("nonconformity_id") @db.Uuid
  riskId            String?      @map("risk_id") @db.Uuid
  dueDate           DateTime?    @map("due_date") @db.Date
  completedAt       DateTime?    @map("completed_at")
  verifiedAt        DateTime?    @map("verified_at")
  verificationNotes String?      @map("verification_notes")
  isEffective       Boolean?     @map("is_effective")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  tenant            Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible       User?        @relation("ActionResponsible", fields: [responsibleId], references: [id])
  nonconformity     Nonconformity? @relation(fields: [nonconformityId], references: [id])
  risk              Risk?        @relation(fields: [riskId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@index([status])
  @@index([nonconformityId])
  @@map("action_plans")
}

// ==================== AUDITS ====================

model Audit {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String         @map("tenant_id") @db.Uuid
  projectId     String         @map("project_id") @db.Uuid
  type          String
  title         String
  startDate     DateTime       @map("start_date") @db.Date
  endDate       DateTime?      @map("end_date") @db.Date
  status        String         @default("planned")
  leadAuditorId String?        @map("lead_auditor_id") @db.Uuid
  scope         String?
  conclusion    String?
  notes         String?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  leadAuditor   User?          @relation("LeadAuditor", fields: [leadAuditorId], references: [id])
  findings      AuditFinding[]

  @@index([tenantId])
  @@index([projectId])
  @@index([status])
  @@map("audits")
}

model AuditFinding {
  id              String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String                @map("tenant_id") @db.Uuid
  auditId         String                @map("audit_id") @db.Uuid
  clauseId        String?               @map("clause_id") @db.Uuid
  classification  FindingClassification @default(observation)
  description     String
  evidence        String?
  nonconformityId String?               @map("nonconformity_id") @db.Uuid
  createdAt       DateTime              @default(now()) @map("created_at")
  tenant          Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  audit           Audit                 @relation(fields: [auditId], references: [id], onDelete: Cascade)
  clause          StandardClause?       @relation(fields: [clauseId], references: [id])
  nonconformity   Nonconformity?        @relation(fields: [nonconformityId], references: [id])

  @@index([tenantId])
  @@index([auditId])
  @@map("audit_findings")
}

// ==================== DOCUMENTS ====================

model Document {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String           @map("tenant_id") @db.Uuid
  projectId      String?          @map("project_id") @db.Uuid
  code           String
  title          String
  type           DocumentType
  category       String?
  version        String           @default("1.0")
  status         DocumentStatus   @default(draft)
  content        String?
  fileUrl        String?          @map("file_url")
  authorId       String           @map("author_id") @db.Uuid
  reviewerId     String?          @map("reviewer_id") @db.Uuid
  approverId     String?          @map("approver_id") @db.Uuid
  approvedAt     DateTime?        @map("approved_at")
  nextReviewDate DateTime?        @map("next_review_date") @db.Date
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project        Project?         @relation(fields: [projectId], references: [id])
  author         User             @relation("DocumentAuthor", fields: [authorId], references: [id])
  reviewer       User?            @relation("DocumentReviewer", fields: [reviewerId], references: [id])
  approver       User?            @relation("DocumentApprover", fields: [approverId], references: [id])
  versions       DocumentVersion[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@index([type])
  @@index([status])
  @@map("documents")
}

model DocumentVersion {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId  String   @map("document_id") @db.Uuid
  version     String
  content     String?
  fileUrl     String?  @map("file_url")
  changedById String   @map("changed_by_id") @db.Uuid
  changeNotes String?  @map("change_notes")
  createdAt   DateTime @default(now()) @map("created_at")
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  changedBy   User     @relation(fields: [changedById], references: [id])

  @@index([documentId])
  @@map("document_versions")
}

// ==================== INDICATORS ====================

model Indicator {
  id           String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String                 @map("tenant_id") @db.Uuid
  projectId    String?                @map("project_id") @db.Uuid
  name         String
  description  String?
  unit         String
  frequency    String
  target       Decimal                @db.Decimal(12, 2)
  lowerLimit   Decimal?               @map("lower_limit") @db.Decimal(12, 2)
  upperLimit   Decimal?               @map("upper_limit") @db.Decimal(12, 2)
  processId    String?                @map("process_id") @db.Uuid
  createdAt    DateTime               @default(now()) @map("created_at")
  updatedAt    DateTime               @updatedAt @map("updated_at")
  tenant       Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project      Project?               @relation(fields: [projectId], references: [id])
  measurements IndicatorMeasurement[]

  @@index([tenantId])
  @@index([projectId])
  @@map("indicators")
}

model IndicatorMeasurement {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  indicatorId String    @map("indicator_id") @db.Uuid
  value       Decimal   @db.Decimal(12, 2)
  period      DateTime  @db.Date
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  indicator   Indicator @relation(fields: [indicatorId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([indicatorId, period])
  @@map("indicator_measurements")
}

// ==================== MANAGEMENT REVIEW ====================

model ManagementReview {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  projectId     String   @map("project_id") @db.Uuid
  scheduledDate DateTime @map("scheduled_date") @db.Date
  actualDate    DateTime? @map("actual_date") @db.Date
  status        String   @default("scheduled")
  minutes       String?
  decisions     Json     @default("[]")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([projectId])
  @@map("management_reviews")
}

// ==================== AUDIT LOG & NOTIFICATIONS ====================

model AuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  metadata   Json     @default("{}")
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String    @map("tenant_id") @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  type       String
  title      String
  message    String
  readAt     DateTime? @map("read_at")
  entityType String?   @map("entity_type")
  entityId   String?   @map("entity_id")
  createdAt  DateTime  @default(now()) @map("created_at")
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([readAt])
  @@map("notifications")
}
