generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum TenantStatus {
  active
  trial
  suspended
  cancelled
}

enum OrgRole {
  tenant_admin
  project_manager
  senior_consultant
  junior_consultant
  internal_auditor
  external_auditor
  client_viewer
}

enum InvitationStatus {
  pending
  accepted
  expired
  revoked
}

enum SubscriptionStatus {
  active
  trialing
  past_due
  cancelled
}

enum ProjectStatus {
  planning
  in_progress
  completed
  archived
}

enum RequirementStatus {
  not_started
  in_progress
  implemented
  verified
  nonconforming
}

enum NcStatus {
  open
  analysis
  action_defined
  in_execution
  effectiveness_check
  closed
}

enum NcSeverity {
  observation
  minor
  major
  critical
}

enum FindingClassification {
  conformity
  observation
  opportunity
  minor_nc
  major_nc
}

enum ActionType {
  corrective
  preventive
  improvement
}

enum ActionStatus {
  planned
  in_progress
  completed
  verified
  effective
  ineffective
}

enum DocumentType {
  policy
  procedure
  work_instruction
  form
  record
  manual
}

enum DocumentStatus {
  draft
  in_review
  approved
  obsolete
}

enum RootCauseMethod {
  five_whys
  ishikawa
  fault_tree
  brainstorming
}

// ==================== GLOBAL MODELS (Super Admin) ====================

model Plan {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  slug          String         @unique
  price         Decimal        @db.Decimal(10, 2)
  maxUsers      Int            @map("max_users")
  maxProjects   Int            @map("max_projects")
  maxStandards  Int            @map("max_standards")
  maxStorage    Int            @map("max_storage") // in MB
  maxClients    Int            @map("max_clients")
  features      Json           @default("{}")
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  subscriptions Subscription[]

  @@map("plans")
}

model Standard {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String            @unique
  name        String
  version     String
  year        Int
  status      String            @default("active")
  description String?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  clauses     StandardClause[]
  controls    StandardControl[]
  projects    ProjectStandard[]

  @@map("standards")
}

model StandardClause {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  standardId          String               @map("standard_id") @db.Uuid
  code                String
  title               String
  description         String?
  parentId            String?              @map("parent_id") @db.Uuid
  orderIndex          Int                  @default(0) @map("order_index")
  createdAt           DateTime             @default(now()) @map("created_at")
  standard            Standard             @relation(fields: [standardId], references: [id], onDelete: Cascade)
  parent              StandardClause?      @relation("ClauseHierarchy", fields: [parentId], references: [id])
  children            StandardClause[]     @relation("ClauseHierarchy")
  projectRequirements ProjectRequirement[]
  nonconformities     Nonconformity[]
  auditFindings       AuditFinding[]

  @@unique([standardId, code])
  @@index([standardId])
  @@index([parentId])
  @@map("standard_clauses")
}

model StandardControl {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  standardId      String           @map("standard_id") @db.Uuid
  code            String
  title           String
  domain          String?
  type            String?
  attributes      Json             @default("{}")
  createdAt       DateTime         @default(now()) @map("created_at")
  standard        Standard         @relation(fields: [standardId], references: [id], onDelete: Cascade)
  projectControls ProjectControl[]
  soaEntries      SoaEntry[]
  riskTreatments  RiskTreatment[]

  @@unique([standardId, code])
  @@index([standardId])
  @@map("standard_controls")
}

// ==================== TENANT MODEL ====================

model Tenant {
  id           String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  slug         String             @unique
  logo         String?
  cnpj         String?
  settings     Json               @default("{}")
  status       TenantStatus       @default(trial)
  trialEndsAt  DateTime?          @map("trial_ends_at")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  members      TenantMember[]
  invitations  Invitation[]
  subscription Subscription?
  clients      ConsultingClient[]
  projects     Project[]
  contexts     OrganizationContext[]
  interestedParties InterestedParty[]
  risks        Risk[]
  actionPlans  ActionPlan[]
  nonconformities Nonconformity[]
  audits       Audit[]
  documents    Document[]
  indicators   Indicator[]
  processes    Process[]
  reviews      ManagementReview[]
  auditLogs    AuditLog[]
  notifications Notification[]
  requirements ProjectRequirement[]
  controls     ProjectControl[]
  soaEntries   SoaEntry[]
  measurements IndicatorMeasurement[]
  auditFindings AuditFinding[]
  sgsiScopes   SgsiScope[]
  communicationPlans CommunicationPlan[]
  competences  Competence[]
  securityObjectives SecurityObjective[]
  policies      Policy[]
  policyAcknowledgments PolicyAcknowledgment[]
  awarenessCampaigns AwarenessCampaign[]
  awarenessParticipants AwarenessParticipant[]
  improvementOpportunities ImprovementOpportunity[]
  securityIncidents SecurityIncident[]
  incidentActions   IncidentAction[]
  informationAssets InformationAsset[]
  suppliers         Supplier[]
  supplierAssessments SupplierAssessment[]
  changeRequests    ChangeRequest[]

  @@map("tenants")
}

// ==================== USER & MEMBERSHIP ====================

model User {
  id          String         @id @db.Uuid
  email       String         @unique
  name        String
  avatarUrl   String?        @map("avatar_url")
  isSuperAdmin Boolean       @default(false) @map("is_super_admin")
  isActive    Boolean        @default(true) @map("is_active")
  lastLoginAt DateTime?      @map("last_login_at")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  memberships TenantMember[]
  invitationsSent Invitation[] @relation("InvitedBy")
  projectMembers ProjectMember[]
  assignedRequirements ProjectRequirement[] @relation("RequirementResponsible")
  assignedControls ProjectControl[] @relation("ControlResponsible")
  assignedRisks Risk[] @relation("RiskResponsible")
  assignedActions ActionPlan[] @relation("ActionResponsible")
  assignedNcs Nonconformity[] @relation("NcResponsible")
  leadAudits Audit[] @relation("LeadAuditor")
  authoredDocuments Document[] @relation("DocumentAuthor")
  reviewedDocuments Document[] @relation("DocumentReviewer")
  approvedDocuments Document[] @relation("DocumentApprover")
  documentVersions DocumentVersion[]
  assignedProcesses Process[] @relation("ProcessResponsible")
  auditLogs AuditLog[]
  notifications Notification[]
  approvedScopes SgsiScope[] @relation("ScopeApprover")
  communicationResponsibilities CommunicationPlan[] @relation("CommunicationResponsible")
  competenceResponsibilities Competence[] @relation("CompetenceResponsible")
  riskReviews RiskHistory[] @relation("RiskReviewer")
  assignedObjectives SecurityObjective[] @relation("ObjectiveResponsible")
  authoredPolicies Policy[] @relation("PolicyAuthor")
  reviewedPolicies Policy[] @relation("PolicyReviewer")
  approvedPolicies Policy[] @relation("PolicyApprover")
  policyAcknowledgments PolicyAcknowledgment[]
  campaignResponsibilities AwarenessCampaign[] @relation("CampaignResponsible")
  awarenessParticipations AwarenessParticipant[]
  improvementResponsibilities ImprovementOpportunity[] @relation("ImprovementResponsible")
  incidentReports           SecurityIncident[] @relation("IncidentReporter")
  incidentAssignments       SecurityIncident[] @relation("IncidentAssignee")
  incidentActionResponsibilities IncidentAction[] @relation("IncidentActionResponsible")
  assetResponsibilities     InformationAsset[] @relation("AssetResponsible")
  supplierResponsibilities  Supplier[] @relation("SupplierResponsible")
  supplierAssessments       SupplierAssessment[] @relation("SupplierAssessor")
  changeRequests            ChangeRequest[] @relation("ChangeRequester")
  changeAssignments         ChangeRequest[] @relation("ChangeAssignee")
  changeApprovals           ChangeRequest[] @relation("ChangeApprover")

  @@map("users")
}

model TenantMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      OrgRole  @default(junior_consultant)
  invitedById String? @map("invited_by_id") @db.Uuid
  joinedAt  DateTime @default(now()) @map("joined_at")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("tenant_members")
}

model Invitation {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String           @map("tenant_id") @db.Uuid
  email     String
  role      OrgRole          @default(junior_consultant)
  token     String           @unique @default(dbgenerated("gen_random_uuid()"))
  status    InvitationStatus @default(pending)
  expiresAt DateTime         @map("expires_at")
  invitedById String         @map("invited_by_id") @db.Uuid
  createdAt DateTime         @default(now()) @map("created_at")
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invitedBy User             @relation("InvitedBy", fields: [invitedById], references: [id])

  @@index([tenantId])
  @@index([token])
  @@index([email])
  @@map("invitations")
}

// ==================== BILLING ====================

model Subscription {
  id                   String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String             @unique @map("tenant_id") @db.Uuid
  planId               String             @map("plan_id") @db.Uuid
  status               SubscriptionStatus @default(trialing)
  stripeCustomerId     String?            @map("stripe_customer_id")
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan                 Plan               @relation(fields: [planId], references: [id])

  @@index([tenantId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

// ==================== CONSULTING CLIENTS ====================

model ConsultingClient {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  name         String
  cnpj         String?
  contactName  String?   @map("contact_name")
  contactEmail String?   @map("contact_email")
  sector       String?
  status       String    @default("active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects     Project[]

  @@index([tenantId])
  @@map("consulting_clients")
}

// ==================== PROJECTS ====================

model Project {
  id            String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String               @map("tenant_id") @db.Uuid
  name          String
  description   String?
  clientId      String?              @map("client_id") @db.Uuid
  status          ProjectStatus        @default(planning)
  startDate       DateTime?            @map("start_date") @db.Date
  endDate         DateTime?            @map("end_date") @db.Date
  progress        Decimal              @default(0) @db.Decimal(5, 2)
  targetMaturity  Int                  @default(3) @map("target_maturity") @db.SmallInt
  archivedAt    DateTime?            @map("archived_at")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client        ConsultingClient?    @relation(fields: [clientId], references: [id])
  standards     ProjectStandard[]
  members       ProjectMember[]
  contexts      OrganizationContext[]
  interestedParties InterestedParty[]
  requirements  ProjectRequirement[]
  controls      ProjectControl[]
  soaEntries    SoaEntry[]
  risks         Risk[]
  actionPlans   ActionPlan[]
  nonconformities Nonconformity[]
  audits        Audit[]
  documents     Document[]
  indicators    Indicator[]
  processes     Process[]
  reviews       ManagementReview[]
  sgsiScopes    SgsiScope[]
  communicationPlans CommunicationPlan[]
  competences   Competence[]
  securityObjectives SecurityObjective[]
  policies      Policy[]
  awarenessCampaigns AwarenessCampaign[]
  improvementOpportunities ImprovementOpportunity[]
  securityIncidents SecurityIncident[]
  informationAssets InformationAsset[]
  suppliers         Supplier[]
  changeRequests    ChangeRequest[]

  @@index([tenantId])
  @@index([clientId])
  @@index([status])
  @@map("projects")
}

model ProjectStandard {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId  String   @map("project_id") @db.Uuid
  standardId String   @map("standard_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  standard   Standard @relation(fields: [standardId], references: [id])

  @@unique([projectId, standardId])
  @@map("project_standards")
}

model ProjectMember {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String  @map("project_id") @db.Uuid
  userId    String  @map("user_id") @db.Uuid
  role      String  @default("member")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

// ==================== REQUIREMENTS & CONTROLS ====================

model ProjectRequirement {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String            @map("tenant_id") @db.Uuid
  projectId     String            @map("project_id") @db.Uuid
  clauseId      String            @map("clause_id") @db.Uuid
  status        RequirementStatus @default(not_started)
  maturity      Int               @default(0) @db.SmallInt
  responsibleId String?           @map("responsible_id") @db.Uuid
  dueDate       DateTime?         @map("due_date") @db.Date
  notes         String?
  evidence      String?
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  clause        StandardClause    @relation(fields: [clauseId], references: [id])
  responsible   User?             @relation("RequirementResponsible", fields: [responsibleId], references: [id])

  @@unique([projectId, clauseId])
  @@index([tenantId])
  @@index([projectId])
  @@map("project_requirements")
}

model ProjectControl {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String          @map("tenant_id") @db.Uuid
  projectId           String          @map("project_id") @db.Uuid
  controlId           String          @map("control_id") @db.Uuid
  status              RequirementStatus @default(not_started)
  maturity            Int             @default(0) @db.SmallInt
  responsibleId       String?         @map("responsible_id") @db.Uuid
  implementationNotes String?         @map("implementation_notes")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project             Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  control             StandardControl @relation(fields: [controlId], references: [id])
  responsible         User?           @relation("ControlResponsible", fields: [responsibleId], references: [id])
  riskTreatments      RiskTreatment[]

  @@unique([projectId, controlId])
  @@index([tenantId])
  @@index([projectId])
  @@map("project_controls")
}

model SoaEntry {
  id                   String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String          @map("tenant_id") @db.Uuid
  projectId            String          @map("project_id") @db.Uuid
  controlId            String          @map("control_id") @db.Uuid
  applicable           Boolean         @default(true)
  justification        String?
  implementationStatus String?         @map("implementation_status")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")
  tenant               Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project              Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  control              StandardControl @relation(fields: [controlId], references: [id])

  @@unique([projectId, controlId])
  @@index([tenantId])
  @@index([projectId])
  @@map("soa_entries")
}

// ==================== ORGANIZATION CONTEXT (ISO 4.1) ====================

model OrganizationContext {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  projectId   String?  @map("project_id") @db.Uuid
  type        String   // "strength" | "weakness" | "opportunity" | "threat"
  category    String?  // "financial" | "technological" | "legal" | "market" | "organizational" | "human_resources"
  title       String
  description String?
  impact      String?  // "high" | "medium" | "low"
  status      String   @default("active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([projectId])
  @@map("organization_contexts")
}

// ==================== INTERESTED PARTIES (ISO 4.2) ====================

model InterestedParty {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  projectId         String?  @map("project_id") @db.Uuid
  name              String
  type              String   // "internal" | "external"
  category          String?  // "employee" | "customer" | "supplier" | "regulator" | "shareholder" | "community" | "partner"
  needsExpectations String?  @map("needs_expectations")
  requirements      String?
  influence         String?  // "high" | "medium" | "low"
  interest          String?  // "high" | "medium" | "low"
  strategy          String?  // "manage_closely" | "keep_satisfied" | "keep_informed" | "monitor"
  monitoringMethod  String?  @map("monitoring_method")
  status            String   @default("active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([projectId])
  @@map("interested_parties")
}

// ==================== RISKS ====================

model Risk {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String          @map("tenant_id") @db.Uuid
  projectId           String          @map("project_id") @db.Uuid
  code                String
  title               String
  description         String
  category            String
  impactDimensions    Json            @default("{}") @map("impact_dimensions")
  probability         Int             @db.SmallInt
  impact              Int             @db.SmallInt
  riskLevel           String          @map("risk_level")
  treatment           String?
  treatmentPlan       String?         @map("treatment_plan")
  responsibleId       String?         @map("responsible_id") @db.Uuid
  status              String          @default("identified")
  residualProbability Int?            @map("residual_probability") @db.SmallInt
  residualImpact      Int?            @map("residual_impact") @db.SmallInt
  nextReviewDate      DateTime?       @map("next_review_date") @db.Date
  monitoringFrequency String?         @map("monitoring_frequency")
  riskAppetite        String?         @map("risk_appetite")
  lastReviewDate      DateTime?       @map("last_review_date") @db.Date
  reviewNotes         String?         @map("review_notes")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project             Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible         User?           @relation("RiskResponsible", fields: [responsibleId], references: [id])
  treatments          RiskTreatment[]
  actionPlans         ActionPlan[]
  history             RiskHistory[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@index([riskLevel])
  @@map("risks")
}

model RiskTreatment {
  id               String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riskId           String          @map("risk_id") @db.Uuid
  controlId        String?         @map("control_id") @db.Uuid
  projectControlId String?         @map("project_control_id") @db.Uuid
  description      String
  status           String          @default("planned")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  risk             Risk            @relation(fields: [riskId], references: [id], onDelete: Cascade)
  control          StandardControl? @relation(fields: [controlId], references: [id])
  projectControl   ProjectControl? @relation(fields: [projectControlId], references: [id])

  @@index([riskId])
  @@map("risk_treatments")
}

// ==================== NONCONFORMITIES ====================

model Nonconformity {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String         @map("tenant_id") @db.Uuid
  projectId     String         @map("project_id") @db.Uuid
  code          String
  title         String
  description   String
  origin        String
  type          String?
  severity      NcSeverity     @default(minor)
  clauseId      String?        @map("clause_id") @db.Uuid
  status        NcStatus       @default(open)
  responsibleId String?        @map("responsible_id") @db.Uuid
  dueDate       DateTime?      @map("due_date") @db.Date
  closedAt      DateTime?      @map("closed_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  clause        StandardClause? @relation(fields: [clauseId], references: [id])
  responsible   User?          @relation("NcResponsible", fields: [responsibleId], references: [id])
  rootCause     NcRootCause?
  actionPlans   ActionPlan[]
  auditFindings AuditFinding[]
  securityIncidents SecurityIncident[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@index([status])
  @@map("nonconformities")
}

model NcRootCause {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nonconformityId String          @unique @map("nonconformity_id") @db.Uuid
  method          RootCauseMethod
  analysis        Json            @default("{}")
  conclusion      String?
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  nonconformity   Nonconformity   @relation(fields: [nonconformityId], references: [id], onDelete: Cascade)

  @@map("nc_root_causes")
}

// ==================== ACTION PLANS ====================

model ActionPlan {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String       @map("tenant_id") @db.Uuid
  projectId         String       @map("project_id") @db.Uuid
  code              String
  title             String
  description       String
  type              ActionType
  status            ActionStatus @default(planned)
  responsibleId     String?      @map("responsible_id") @db.Uuid
  nonconformityId   String?      @map("nonconformity_id") @db.Uuid
  riskId            String?      @map("risk_id") @db.Uuid
  dueDate           DateTime?    @map("due_date") @db.Date
  completedAt       DateTime?    @map("completed_at")
  verifiedAt        DateTime?    @map("verified_at")
  verificationNotes String?      @map("verification_notes")
  isEffective       Boolean?     @map("is_effective")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  tenant            Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible       User?        @relation("ActionResponsible", fields: [responsibleId], references: [id])
  nonconformity     Nonconformity? @relation(fields: [nonconformityId], references: [id])
  risk              Risk?        @relation(fields: [riskId], references: [id])
  improvements      ImprovementOpportunity[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@index([status])
  @@index([nonconformityId])
  @@map("action_plans")
}

// ==================== AUDITS ====================

model Audit {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String         @map("tenant_id") @db.Uuid
  projectId     String         @map("project_id") @db.Uuid
  type          String
  title         String
  startDate     DateTime       @map("start_date") @db.Date
  endDate       DateTime?      @map("end_date") @db.Date
  status        String         @default("planned")
  leadAuditorId String?        @map("lead_auditor_id") @db.Uuid
  scope         String?
  conclusion    String?
  notes         String?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  leadAuditor   User?          @relation("LeadAuditor", fields: [leadAuditorId], references: [id])
  findings      AuditFinding[]

  @@index([tenantId])
  @@index([projectId])
  @@index([status])
  @@map("audits")
}

model AuditFinding {
  id              String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String                @map("tenant_id") @db.Uuid
  auditId         String                @map("audit_id") @db.Uuid
  clauseId        String?               @map("clause_id") @db.Uuid
  classification  FindingClassification @default(observation)
  description     String
  evidence        String?
  nonconformityId String?               @map("nonconformity_id") @db.Uuid
  createdAt       DateTime              @default(now()) @map("created_at")
  tenant          Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  audit           Audit                 @relation(fields: [auditId], references: [id], onDelete: Cascade)
  clause          StandardClause?       @relation(fields: [clauseId], references: [id])
  nonconformity   Nonconformity?        @relation(fields: [nonconformityId], references: [id])

  @@index([tenantId])
  @@index([auditId])
  @@map("audit_findings")
}

// ==================== DOCUMENTS ====================

model Document {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String           @map("tenant_id") @db.Uuid
  projectId      String?          @map("project_id") @db.Uuid
  code           String
  title          String
  type           DocumentType
  category       String?
  version        String           @default("1.0")
  status         DocumentStatus   @default(draft)
  content        String?
  fileUrl        String?          @map("file_url")
  authorId       String           @map("author_id") @db.Uuid
  reviewerId     String?          @map("reviewer_id") @db.Uuid
  approverId     String?          @map("approver_id") @db.Uuid
  approvedAt     DateTime?        @map("approved_at")
  nextReviewDate DateTime?        @map("next_review_date") @db.Date
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project        Project?         @relation(fields: [projectId], references: [id])
  author         User             @relation("DocumentAuthor", fields: [authorId], references: [id])
  reviewer       User?            @relation("DocumentReviewer", fields: [reviewerId], references: [id])
  approver       User?            @relation("DocumentApprover", fields: [approverId], references: [id])
  versions       DocumentVersion[]
  policies       Policy[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@index([type])
  @@index([status])
  @@map("documents")
}

model DocumentVersion {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId  String   @map("document_id") @db.Uuid
  version     String
  content     String?
  fileUrl     String?  @map("file_url")
  changedById String   @map("changed_by_id") @db.Uuid
  changeNotes String?  @map("change_notes")
  createdAt   DateTime @default(now()) @map("created_at")
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  changedBy   User     @relation(fields: [changedById], references: [id])

  @@index([documentId])
  @@map("document_versions")
}

// ==================== PROCESSES ====================

model Process {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String      @map("tenant_id") @db.Uuid
  projectId     String      @map("project_id") @db.Uuid
  code          String
  name          String
  description   String?
  responsibleId String?     @map("responsible_id") @db.Uuid
  status        String      @default("active")
  category      String?
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible   User?       @relation("ProcessResponsible", fields: [responsibleId], references: [id])
  indicators    Indicator[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@map("processes")
}

// ==================== INDICATORS ====================

model Indicator {
  id           String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String                 @map("tenant_id") @db.Uuid
  projectId    String?                @map("project_id") @db.Uuid
  name         String
  description  String?
  unit         String
  frequency    String
  target       Decimal                @db.Decimal(12, 2)
  lowerLimit   Decimal?               @map("lower_limit") @db.Decimal(12, 2)
  upperLimit   Decimal?               @map("upper_limit") @db.Decimal(12, 2)
  processId    String?                @map("process_id") @db.Uuid
  createdAt    DateTime               @default(now()) @map("created_at")
  updatedAt    DateTime               @updatedAt @map("updated_at")
  tenant       Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project      Project?               @relation(fields: [projectId], references: [id])
  process      Process?               @relation(fields: [processId], references: [id])
  measurements IndicatorMeasurement[]
  objectives   SecurityObjective[]

  @@index([tenantId])
  @@index([projectId])
  @@map("indicators")
}

model IndicatorMeasurement {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  indicatorId String    @map("indicator_id") @db.Uuid
  value       Decimal   @db.Decimal(12, 2)
  period      DateTime  @db.Date
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  indicator   Indicator @relation(fields: [indicatorId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([indicatorId, period])
  @@map("indicator_measurements")
}

// ==================== MANAGEMENT REVIEW ====================

model ManagementReview {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  projectId     String   @map("project_id") @db.Uuid
  scheduledDate DateTime @map("scheduled_date") @db.Date
  actualDate    DateTime? @map("actual_date") @db.Date
  status        String   @default("scheduled")
  minutes       String?
  decisions     Json     @default("[]")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([projectId])
  @@map("management_reviews")
}

// ==================== AUDIT LOG & NOTIFICATIONS ====================

model AuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  metadata   Json     @default("{}")
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String    @map("tenant_id") @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  type       String
  title      String
  message    String
  readAt     DateTime? @map("read_at")
  entityType String?   @map("entity_type")
  entityId   String?   @map("entity_id")
  createdAt  DateTime  @default(now()) @map("created_at")
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([readAt])
  @@map("notifications")
}

// ==================== SGSI SCOPE (ISO 4.3) ====================

model SgsiScope {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  projectId     String    @map("project_id") @db.Uuid
  title         String
  description   String?
  boundaries    String?
  exclusions    String?
  justification String?
  interfaces    String?
  status        String    @default("draft")
  approvedById  String?   @map("approved_by_id") @db.Uuid
  approvedAt    DateTime? @map("approved_at")
  version       String    @default("1.0")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  approvedBy    User?     @relation("ScopeApprover", fields: [approvedById], references: [id])

  @@index([tenantId])
  @@index([projectId])
  @@map("sgsi_scopes")
}

// ==================== COMMUNICATION PLAN (ISO 7.4) ====================

model CommunicationPlan {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  projectId     String   @map("project_id") @db.Uuid
  topic         String
  audience      String
  frequency     String
  method        String
  responsibleId String?  @map("responsible_id") @db.Uuid
  notes         String?
  status        String   @default("active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible   User?    @relation("CommunicationResponsible", fields: [responsibleId], references: [id])

  @@index([tenantId])
  @@index([projectId])
  @@map("communication_plans")
}

// ==================== COMPETENCES (ISO 7.2) ====================

model Competence {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String    @map("tenant_id") @db.Uuid
  projectId          String    @map("project_id") @db.Uuid
  role               String
  requiredCompetence String    @map("required_competence")
  currentLevel       String?   @map("current_level")
  trainingAction     String?   @map("training_action")
  trainingType       String?   @map("training_type")
  evidence           String?
  evidenceFileUrl    String?   @map("evidence_file_url")
  responsibleId      String?   @map("responsible_id") @db.Uuid
  status             String    @default("identified")
  dueDate            DateTime? @map("due_date") @db.Date
  completedAt        DateTime? @map("completed_at")
  notes              String?
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  tenant             Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project            Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible        User?     @relation("CompetenceResponsible", fields: [responsibleId], references: [id])

  @@index([tenantId])
  @@index([projectId])
  @@map("competences")
}

// ==================== RISK HISTORY ====================

model RiskHistory {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  riskId              String   @map("risk_id") @db.Uuid
  probability         Int      @db.SmallInt
  impact              Int      @db.SmallInt
  riskLevel           String   @map("risk_level")
  residualProbability Int?     @map("residual_probability") @db.SmallInt
  residualImpact      Int?     @map("residual_impact") @db.SmallInt
  status              String
  reviewNotes         String?  @map("review_notes")
  reviewedById        String?  @map("reviewed_by_id") @db.Uuid
  createdAt           DateTime @default(now()) @map("created_at")
  risk                Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  reviewedBy          User?    @relation("RiskReviewer", fields: [reviewedById], references: [id])

  @@index([riskId])
  @@index([createdAt])
  @@map("risk_history")
}

// ==================== SECURITY OBJECTIVES (ISO 6.2) ====================

model SecurityObjective {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String    @map("tenant_id") @db.Uuid
  projectId           String    @map("project_id") @db.Uuid
  code                String
  title               String
  description         String?
  category            String?
  targetValue         Decimal?  @map("target_value") @db.Decimal(12, 2)
  targetUnit          String?   @map("target_unit")
  currentValue        Decimal?  @map("current_value") @db.Decimal(12, 2)
  deadline            DateTime? @db.Date
  indicatorId         String?   @map("indicator_id") @db.Uuid
  responsibleId       String?   @map("responsible_id") @db.Uuid
  status              String    @default("defined")
  measurable          Boolean   @default(true)
  monitoringFrequency String?   @map("monitoring_frequency")
  achievedAt          DateTime? @map("achieved_at")
  notes               String?
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project             Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  indicator           Indicator? @relation(fields: [indicatorId], references: [id])
  responsible         User?     @relation("ObjectiveResponsible", fields: [responsibleId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@map("security_objectives")
}

// ==================== POLICIES (ISO 5.2) ====================

model Policy {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String              @map("tenant_id") @db.Uuid
  projectId       String              @map("project_id") @db.Uuid
  code            String
  title           String
  description     String?
  content         String?
  category        String?
  version         String              @default("1.0")
  status          String              @default("draft")
  authorId        String              @map("author_id") @db.Uuid
  reviewerId      String?             @map("reviewer_id") @db.Uuid
  approverId      String?             @map("approver_id") @db.Uuid
  approvedAt      DateTime?           @map("approved_at")
  publishedAt     DateTime?           @map("published_at")
  nextReviewDate  DateTime?           @map("next_review_date") @db.Date
  documentId      String?             @map("document_id") @db.Uuid
  fileUrl         String?             @map("file_url")
  notes           String?
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project         Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author          User                @relation("PolicyAuthor", fields: [authorId], references: [id])
  reviewer        User?               @relation("PolicyReviewer", fields: [reviewerId], references: [id])
  approver        User?               @relation("PolicyApprover", fields: [approverId], references: [id])
  document        Document?           @relation(fields: [documentId], references: [id])
  acknowledgments PolicyAcknowledgment[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@map("policies")
}

model PolicyAcknowledgment {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  policyId        String   @map("policy_id") @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  acknowledgedAt  DateTime @default(now()) @map("acknowledged_at")
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  policy          Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([policyId, userId])
  @@index([tenantId])
  @@index([policyId])
  @@map("policy_acknowledgments")
}

// ==================== AWARENESS CAMPAIGNS (ISO 7.3) ====================

model AwarenessCampaign {
  id              String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String                @map("tenant_id") @db.Uuid
  projectId       String                @map("project_id") @db.Uuid
  code            String
  title           String
  description     String?
  type            String
  targetAudience  String?               @map("target_audience")
  startDate       DateTime              @map("start_date") @db.Date
  endDate         DateTime?             @map("end_date") @db.Date
  duration        Int?
  location        String?
  instructor      String?
  materials       String?
  status          String                @default("planned")
  completionRate  Decimal?              @map("completion_rate") @db.Decimal(5, 2)
  responsibleId   String?               @map("responsible_id") @db.Uuid
  notes           String?
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  tenant          Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project         Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible     User?                 @relation("CampaignResponsible", fields: [responsibleId], references: [id])
  participants    AwarenessParticipant[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@map("awareness_campaigns")
}

model AwarenessParticipant {
  id              String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String             @map("tenant_id") @db.Uuid
  campaignId      String             @map("campaign_id") @db.Uuid
  userId          String?            @map("user_id") @db.Uuid
  externalName    String?            @map("external_name")
  externalEmail   String?            @map("external_email")
  attended        Boolean            @default(false)
  completedAt     DateTime?          @map("completed_at")
  score           Decimal?           @db.Decimal(5, 2)
  feedback        String?
  status          String             @default("invited")
  createdAt       DateTime           @default(now()) @map("created_at")
  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  campaign        AwarenessCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user            User?              @relation(fields: [userId], references: [id])

  @@unique([campaignId, userId])
  @@index([tenantId])
  @@index([campaignId])
  @@map("awareness_participants")
}

// ==================== IMPROVEMENT OPPORTUNITIES (ISO 10.3) ====================

model ImprovementOpportunity {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  projectId       String    @map("project_id") @db.Uuid
  code            String
  title           String
  description     String?
  source          String
  category        String?
  priority        String    @default("medium")
  expectedImpact  String?   @map("expected_impact")
  actualImpact    String?   @map("actual_impact")
  responsibleId   String?   @map("responsible_id") @db.Uuid
  status          String    @default("identified")
  actionPlanId    String?   @map("action_plan_id") @db.Uuid
  dueDate         DateTime? @map("due_date") @db.Date
  implementedAt   DateTime? @map("implemented_at")
  verifiedAt      DateTime? @map("verified_at")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible     User?     @relation("ImprovementResponsible", fields: [responsibleId], references: [id])
  actionPlan      ActionPlan? @relation(fields: [actionPlanId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@map("improvement_opportunities")
}

// ==================== SECURITY INCIDENTS (ISO A.5.24-A.5.28) ====================

model SecurityIncident {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String           @map("tenant_id") @db.Uuid
  projectId         String           @map("project_id") @db.Uuid
  code              String
  title             String
  description       String?
  type              String           // data_breach | unauthorized_access | malware | phishing | denial_of_service | physical | social_engineering | other
  severity          String           @default("medium") // low | medium | high | critical
  category          String?          // confidentiality | integrity | availability | multiple
  detectedAt        DateTime         @map("detected_at")
  reportedAt        DateTime         @default(now()) @map("reported_at")
  resolvedAt        DateTime?        @map("resolved_at")
  closedAt          DateTime?        @map("closed_at")
  affectedAssets    String?          @map("affected_assets")
  affectedSystems   String?          @map("affected_systems")
  impactDescription String?          @map("impact_description")
  rootCause         String?          @map("root_cause")
  containmentActions String?         @map("containment_actions")
  correctiveActions String?          @map("corrective_actions")
  lessonsLearned    String?          @map("lessons_learned")
  reportedById      String           @map("reported_by_id") @db.Uuid
  assignedToId      String?          @map("assigned_to_id") @db.Uuid
  status            String           @default("reported") // reported | triaged | contained | investigating | resolved | closed
  notifiedAuthorities Boolean        @default(false) @map("notified_authorities")
  nonconformityId   String?          @map("nonconformity_id") @db.Uuid
  notes             String?
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reportedBy        User             @relation("IncidentReporter", fields: [reportedById], references: [id])
  assignedTo        User?            @relation("IncidentAssignee", fields: [assignedToId], references: [id])
  nonconformity     Nonconformity?   @relation(fields: [nonconformityId], references: [id])
  actions           IncidentAction[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@map("security_incidents")
}

model IncidentAction {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String           @map("tenant_id") @db.Uuid
  incidentId        String           @map("incident_id") @db.Uuid
  description       String
  type              String           // containment | eradication | recovery | preventive
  responsibleId     String?          @map("responsible_id") @db.Uuid
  dueDate           DateTime?        @map("due_date") @db.Date
  completedAt       DateTime?        @map("completed_at")
  status            String           @default("pending") // pending | in_progress | completed
  notes             String?
  createdAt         DateTime         @default(now()) @map("created_at")
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  incident          SecurityIncident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  responsible       User?            @relation("IncidentActionResponsible", fields: [responsibleId], references: [id])

  @@index([tenantId])
  @@index([incidentId])
  @@map("incident_actions")
}

// ==================== INFORMATION ASSETS (ISO A.5.9-A.5.11) ====================

model InformationAsset {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  projectId         String    @map("project_id") @db.Uuid
  code              String
  name              String
  description       String?
  type              String    // hardware | software | data | service | people | facility | network | other
  category          String?   // primary | support | infrastructure
  owner             String?
  custodian         String?
  location          String?
  classification    String    @default("internal") // public | internal | confidential | restricted
  criticality       String    @default("medium") // low | medium | high | critical
  businessValue     String?   @map("business_value")
  status            String    @default("active") // active | inactive | decommissioned | under_review
  acquisitionDate   DateTime? @map("acquisition_date") @db.Date
  endOfLifeDate     DateTime? @map("end_of_life_date") @db.Date
  lastReviewDate    DateTime? @map("last_review_date") @db.Date
  nextReviewDate    DateTime? @map("next_review_date") @db.Date
  responsibleId     String?   @map("responsible_id") @db.Uuid
  notes             String?
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible       User?     @relation("AssetResponsible", fields: [responsibleId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@map("information_assets")
}

// ==================== SUPPLIERS (ISO A.5.19-A.5.23) ====================

model Supplier {
  id                String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String               @map("tenant_id") @db.Uuid
  projectId         String               @map("project_id") @db.Uuid
  code              String
  name              String
  cnpj              String?
  contactName       String?              @map("contact_name")
  contactEmail      String?              @map("contact_email")
  contactPhone      String?              @map("contact_phone")
  type              String               // cloud_provider | saas | outsourcing | consulting | data_processor | infrastructure | other
  category          String?              // critical | important | standard
  servicesProvided  String?              @map("services_provided")
  dataAccess        String?              @map("data_access") // none | limited | full
  contractStartDate DateTime?            @map("contract_start_date") @db.Date
  contractEndDate   DateTime?            @map("contract_end_date") @db.Date
  slaDetails        String?              @map("sla_details")
  securityRequirements String?           @map("security_requirements")
  riskLevel         String               @default("medium") // low | medium | high | critical
  status            String               @default("active") // active | under_review | suspended | terminated
  responsibleId     String?              @map("responsible_id") @db.Uuid
  lastAssessmentDate DateTime?           @map("last_assessment_date") @db.Date
  nextAssessmentDate DateTime?           @map("next_assessment_date") @db.Date
  notes             String?
  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")
  tenant            Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responsible       User?                @relation("SupplierResponsible", fields: [responsibleId], references: [id])
  assessments       SupplierAssessment[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@map("suppliers")
}

model SupplierAssessment {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  supplierId        String    @map("supplier_id") @db.Uuid
  assessmentDate    DateTime  @map("assessment_date") @db.Date
  assessorId        String?   @map("assessor_id") @db.Uuid
  overallScore      Decimal?  @map("overall_score") @db.Decimal(5, 2)
  securityScore     Decimal?  @map("security_score") @db.Decimal(5, 2)
  complianceScore   Decimal?  @map("compliance_score") @db.Decimal(5, 2)
  serviceScore      Decimal?  @map("service_score") @db.Decimal(5, 2)
  findings          String?
  recommendations   String?
  status            String    @default("completed") // planned | in_progress | completed
  nextAssessmentDate DateTime? @map("next_assessment_date") @db.Date
  notes             String?
  createdAt         DateTime  @default(now()) @map("created_at")
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier          Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  assessor          User?     @relation("SupplierAssessor", fields: [assessorId], references: [id])

  @@index([tenantId])
  @@index([supplierId])
  @@map("supplier_assessments")
}

// ==================== CHANGE REQUESTS (ISO 6.3) ====================

model ChangeRequest {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  projectId         String    @map("project_id") @db.Uuid
  code              String
  title             String
  description       String?
  type              String    // process | technology | organizational | documentation | control | scope | other
  reason            String?
  impactAnalysis    String?   @map("impact_analysis")
  riskAssessment    String?   @map("risk_assessment")
  rollbackPlan      String?   @map("rollback_plan")
  priority          String    @default("medium") // low | medium | high | urgent
  requestedById     String    @map("requested_by_id") @db.Uuid
  assignedToId      String?   @map("assigned_to_id") @db.Uuid
  approvedById      String?   @map("approved_by_id") @db.Uuid
  approvedAt        DateTime? @map("approved_at")
  implementedAt     DateTime? @map("implemented_at")
  verifiedAt        DateTime? @map("verified_at")
  rejectedAt        DateTime? @map("rejected_at")
  plannedDate       DateTime? @map("planned_date") @db.Date
  status            String    @default("requested") // requested | under_review | approved | in_progress | implemented | verified | rejected | cancelled
  affectedAreas     String?   @map("affected_areas")
  notes             String?
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  requestedBy       User      @relation("ChangeRequester", fields: [requestedById], references: [id])
  assignedTo        User?     @relation("ChangeAssignee", fields: [assignedToId], references: [id])
  approvedBy        User?     @relation("ChangeApprover", fields: [approvedById], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([projectId])
  @@map("change_requests")
}
